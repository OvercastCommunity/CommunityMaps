<map proto="1.5.0">
<name>Glass Bridge</name>
<version>1.1.2</version>
<game>Glass Bridge</game>
<include id="void-death"/>
<objective>Get across the glass bridge without falling off!</objective>
<authors>
    <author uuid="e6b3183f-f4d7-40d5-b0a7-34c481938be1"/> <!-- emcode -->
    <author uuid="759c7730-4702-4bb1-85c0-d6be18069c59"/> <!-- Beanes -->
</authors>
<players min="3" max="64" max-overfill="64"/>
<regions>
    <cylinder id="spawn" base="0.5,50,3.5" height="0" radius="1"/>
    <union id="platforms">
        <union id="platforms-a">
            <complement id="base-platform">
                <union>
                    <cuboid min="-5,49,9" size="5,6,5"/>
                    <cuboid min="0,49,14" size="5,6,5"/>
                </union>
                <cuboid min="-2,49,9" size="2,6,1"/>
                <cuboid min="-2,49,13" size="4,6,2"/>
                <cuboid min="0,49,18" size="2,6,1"/>
            </complement>
            <translate region="base-platform" offset="0,0,10"/>
            <translate region="base-platform" offset="0,0,20"/>
            <translate region="base-platform" offset="0,0,30"/>
            <translate region="base-platform" offset="0,0,40"/>
            <translate region="base-platform" offset="0,0,50"/>
            <translate region="base-platform" offset="0,0,60"/>
            <translate region="base-platform" offset="0,0,70"/>
            <translate region="base-platform" offset="0,0,80"/>
            <translate region="base-platform" offset="0,0,90"/>
            <translate region="base-platform" offset="0,0,100"/>
            <translate region="base-platform" offset="0,0,110"/>
            <translate region="base-platform" offset="0,0,120"/>
            <translate region="base-platform" offset="0,0,130"/>
            <translate region="base-platform" offset="0,0,140"/>
            <translate region="base-platform" offset="0,0,150"/>
            <translate region="base-platform" offset="0,0,160"/>
        </union>
        <mirror id="platforms-b" region="platforms-a" normal="1,0,0" origin="0,0,0"/>
    </union>
    <cuboid id="spawn-region" min="-5,46,0" max="6,56,8" />
    <apply block="deny(participating)" region="everywhere"/>
    <apply kit="enter-end-region-kit" region="end_region"/>
</regions>
<spawns>
    <spawn filter="deny(after-1s)" kit="spawn-kit">
        <region>
            <cylinder base="0.5,50,3.5" height="0" radius="1"/>
        </region>
    </spawn>
    <default>
        <region>
            <cylinder base="0.5,70,-22.5" height="0" radius="1"/>
        </region>
    </default>
</spawns>
<time result="objectives">10m</time>
<variables>
    <array id="platform_states" size="64" scope="match"/>
    <variable id="platform_count" default="0" scope="match"/>
    <variable id="platform_index" default="0" scope="match"/>
    <variable id="platform_diff" default="0" scope="player"/>
    <variable id="platform_state" default="0" scope="match"/>
    <variable id="platform_destroyed" default="0" scope="match"/>
    <variable id="player_count" default="0" scope="match"/>
    <variable id="is_dying" default="0" scope="player"/>
    <variable id="complete" default="0" scope="player"/>
    <variable id="completions" default="0" scope="match"/>
    <variable id="recent_completion" default="0" scope="player" exclusive="1"/>
    <cuboid id="end_region" min="0,0,0" max="0,0,0"/>
    <cuboid id="fill_region" min="0,0,0" max="0,0,0"/>
    <timelimit id="timelimit"/>
</variables>
<filters>
    <time id="after-1s">1s</time>
</filters>
<actions>
    <action id="enter-platform-region" scope="player">
        <set var="platform_index" value="floor((floor(player.z + 0.5) - 9.0) / 5.0)"/>
        <set var="platform_diff" value="platform_index - platform_count"/>
        <action filter="all(platform_diff=..-1,platform_index=0..)">
            <set var="platform_diff" value="platform_index - score"/>
            <action filter="platform_diff=..0">
                <set var="platform_state" value="platform_states[platform_index]"/>
                <action filter="is_dying=1">
                    <!-- Prevents laggers from crossing multiple platforms -->
                    <teleport x="player.x" y="player.y - 5" z="player.z" />
                </action>
                <action filter="all(any(all(player.x=..0,platform_state=0),all(player.x=0..,platform_state=1)),is_dying=0)">
                    <set var="is_dying" value="1"/>
                    <set var="platform_states" index="platform_index" value="-1"/>
                    <switch-scope inner="match" outer="player">
                        <set var="fill_region" index="0" value="-3 + (platform_state * 5)"/>
                        <set var="fill_region" index="1" value="49"/>
                        <set var="fill_region" index="2" value="11 + (platform_index * 5)"/>
                        <set var="fill_region" index="3" value="fill_region[0] + 1"/>
                        <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                        <set var="fill_region" index="5" value="fill_region[2] + 1"/>
                        <fill region="fill_region" material="stained_glass:14" events="true"/>
                        <sound key="dig.glass"/>
                    </switch-scope>
                </action>
                <action filter="is_dying=0">
                    <set var="score" value="platform_index + 1"/>
                </action>
            </action>
            <action filter="platform_diff=1..">
                <teleport x="player.x" y="player.y - 5" z="player.z" />
                <sound preset="PORTAL"/>
            </action>
        </action>
    </action>
    <action id="enter-end-region" scope="player">
        <set var="platform_diff" value="platform_count - score"/>
        <action filter="platform_diff=0">
            <teleport x="0.5" y="70" z="-22.5" yaw="0" pitch="0"/>
            <set var="completions" value="completions + 1"/>
            <set var="recent_completion" value="1"/>
            <set var="complete" value="1"/>
            <switch-scope inner="match">
                <message text="{player} `ahas crossed the glass bridge in position `3#{position}`a!">
                    <replacements>
                        <player id="player" var="recent_completion"/>
                        <decimal id="position" value="completions"/>
                    </replacements>
                </message>
                <sound preset="OBJECTIVE_FIREWORKS_FAR"/>
            </switch-scope>
            <sound preset="SCORE"/>
            <action filter="completions=1">
                <set var="score" value="score + 1"/>
                <sound preset="OBJECTIVE_GOOD"/>
                <action filter="timelimit=20..">
                    <set var="timelimit" value="20"/>
                    <switch-scope inner="match">
                        <message text="`aThe timer has been shortened to `c20 seconds"/>
                    </switch-scope>
                </action>
            </action>
        </action>
        <action filter="all(platform_diff=1..,not(complete=1))">
            <teleport x="player.x" y="player.y - 5" z="player.z" />
            <sound preset="PORTAL"/>
        </action>
    </action>
    <action id="remove-spawn" scope="match">
        <fill region="spawn-region" material="air"/>
    </action>
    <action id="remove-platform" scope="match">
        <set var="fill_region" index="0" value="-3"/>
        <set var="fill_region" index="1" value="49"/>
        <set var="fill_region" index="2" value="11 + (platform_destroyed * 5)"/>
        <set var="fill_region" index="3" value="fill_region[0] + 1"/>
        <set var="fill_region" index="4" value="fill_region[1] + 1"/>
        <set var="fill_region" index="5" value="fill_region[2] + 1"/>
        <fill region="fill_region" material="stained_glass:14" events="true"/>
        <set var="fill_region" index="0" value="3"/>
        <set var="fill_region" index="3" value="fill_region[0] + 1"/>
        <fill region="fill_region" material="stained_glass:14" events="true"/>
        <sound key="dig.glass"/>
        <set var="platform_destroyed" value="platform_destroyed + 1"/>
    </action>
    <trigger filter="all(alive,platforms-a)" action="enter-platform-region" scope="player"/>
    <trigger filter="all(alive,platforms-b)" action="enter-platform-region" scope="player"/>
    <trigger filter="all(spawn-region,alive,not(complete=1))" scope="player">
        <action>
            <set var="score" value="0"/>
        </action>
    </trigger>
    <trigger filter="any(all(not(alive), after-1s),complete=1)" scope="player">
        <action>
            <switch-scope outer="player" inner="match">
                <set var="player_count" value="0"/>
                <switch-scope inner="player" outer="match">
                    <action filter="all(alive,not(complete=1))">
                        <set var="player_count" value="player_count + 1"/>
                    </action>
                </switch-scope>
                <action filter="player_count=0">
                    <set var="timelimit" value="0"/>
                </action>
            </switch-scope>
        </action>
    </trigger>
    <!-- Workaround, because you can still lose despite being last one alive. -->
    <trigger scope="player">
        <filter>
            <after duration="1s">
                <dead/>
            </after>
        </filter>
        <action>
            <teleport x="0.5" y="51" z="3.5" yaw="0" pitch="0"/>
        </action>
    </trigger>
    <trigger filter="match-started" scope="match">
        <action scope="match">
            <set var="player_count" value="0"/>
            <switch-scope inner="player" outer="match">
                <set var="player_count" value="player_count + 1"/>
            </switch-scope>
            <set var="platform_count" value="min(max(floor(player_count * 0.8), 3), 32)"/>
            <set var="platform_index" value="0"/>
            <repeat times="platform_count">
                <set var="platform_states" index="platform_index" value="floor(random() * 2)"/>
                <paste-structure x="-3" y="50" z="11 + (platform_index * 5)" structure="platform"/>
                <paste-structure x="2" y="50" z="11 + (platform_index * 5)" structure="platform"/>
                <set var="fill_region" index="1" value="49"/>
                <set var="fill_region" index="2" value="11 + (platform_index * 5)"/>
                <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                <set var="fill_region" index="5" value="fill_region[2] + 1"/>
                <!-- Place a torch on the right hand side -->
                <set var="fill_region" index="0" value="-6"/>
                <set var="fill_region" index="3" value="fill_region[0] + 1"/>
                <fill region="fill_region" material="stone" update="false" />
                <set var="fill_region" index="1" value="50"/>
                <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                <fill region="fill_region" material="torch" update="false" />
                <set var="fill_region" index="1" value="49"/>
                <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                <fill region="fill_region" material="air" update="false" />
                <!-- Place a torch on the left hand side -->
                <set var="fill_region" index="0" value="5"/>
                <set var="fill_region" index="3" value="fill_region[0] + 1"/>
                <fill region="fill_region" material="stone" update="false" />
                <set var="fill_region" index="1" value="50"/>
                <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                <fill region="fill_region" material="torch" update="false" />
                <set var="fill_region" index="1" value="49"/>
                <set var="fill_region" index="4" value="fill_region[1] + 1"/>
                <fill region="fill_region" material="air" update="false" />
                <set var="platform_index" value="platform_index + 1"/>
            </repeat>
            <paste-structure x="-4" y="47" z="11 + (platform_count * 5)" structure="end-island"/>
            <set var="end_region" index="0" value="-5"/>
            <set var="end_region" index="1" value="50"/>
            <set var="end_region" index="2" value="14 + (platform_count * 5)"/>
            <set var="end_region" index="3" value="5"/>
            <set var="end_region" index="4" value="55"/>
            <set var="end_region" index="5" value="18 + (platform_count * 5)"/>
        </action>
    </trigger>
</actions>
<modes show-before="10s">
    <mode after="20s" action="remove-spawn" name="Removing spawn"/>
</modes>
<modes show-before="5s" action="remove-platform" name="Platform falling">
    <mode after="25s" filter="platform_count=1.."/>
    <mode after="30s" filter="platform_count=2.."/>
    <mode after="35s" filter="platform_count=3.."/>
    <mode after="40s" filter="platform_count=4.."/>
    <mode after="45s" filter="platform_count=5.."/>
    <mode after="50s" filter="platform_count=6.."/>
    <mode after="55s" filter="platform_count=7.."/>
    <mode after="60s" filter="platform_count=8.."/>
    <mode after="65s" filter="platform_count=9.."/>
    <mode after="70s" filter="platform_count=10.."/>
    <mode after="75s" filter="platform_count=11.."/>
    <mode after="80s" filter="platform_count=12.."/>
    <mode after="85s" filter="platform_count=13.."/>
    <mode after="90s" filter="platform_count=14.."/>
    <mode after="95s" filter="platform_count=15.."/>
    <mode after="100s" filter="platform_count=16.."/>
    <mode after="105s" filter="platform_count=17.."/>
    <mode after="110s" filter="platform_count=18.."/>
    <mode after="115s" filter="platform_count=19.."/>
    <mode after="120s" filter="platform_count=20.."/>
    <mode after="125s" filter="platform_count=21.."/>
    <mode after="130s" filter="platform_count=22.."/>
    <mode after="135s" filter="platform_count=23.."/>
    <mode after="140s" filter="platform_count=24.."/>
    <mode after="145s" filter="platform_count=25.."/>
    <mode after="150s" filter="platform_count=26.."/>
    <mode after="155s" filter="platform_count=27.."/>
    <mode after="160s" filter="platform_count=28.."/>
    <mode after="165s" filter="platform_count=29.."/>
    <mode after="170s" filter="platform_count=30.."/>
    <mode after="175s" filter="platform_count=31.."/>
    <mode after="180s" filter="platform_count=32.."/>
</modes>
<blitz filter="deny(always)"/>
<score/>
<respawn delay="0s" auto="true" spectate="true">
    <message>You can now spectate the game!</message>
</respawn>
<kits>
    <kit id="spawn-kit">
        <effect amplifier="1">invisibility</effect>
        <boots material="leather boots" team-color="true" unbreakable="true"/>
        <leggings material="leather leggings" team-color="true" unbreakable="true"/>
    </kit>
    <kit id="enter-end-region-kit">
        <action id="enter-end-region"/>
    </kit>
</kits>
<structures>
    <structure id="end-island" air="true">
        <region>
            <cuboid min="-5,46,-13" max="6,51,-5"/>
        </region>
    </structure>
    <structure id="platform" air="true">
        <region>
            <cuboid min="-1,49,11" max="2,50,14"/>
        </region>
    </structure>
</structures>
<falling-blocks>
    <rule>
        <filter>
            <material>stained_glass</material>
        </filter>
    </rule>
</falling-blocks>
<hunger>
    <depletion>off</depletion>
</hunger>
<damage>
    <deny>
        <not>
            <cause>void</cause>
        </not>
    </deny>
</damage>
</map>

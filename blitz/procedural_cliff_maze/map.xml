<map proto="1.5.0">
<name>Procedural: Cliff Maze</name>
<version>3.0.0</version>
<created>2023-09-05</created>
<objective>Kill all player's on the enemy team to win!</objective>
<include id="gapple-kill-reward"/>
<authors>
    <author uuid="cc2292de-fcb3-412d-9319-f3177f73b605"/> <!-- cs_ -->
    <author uuid="2ca8072f-74be-4798-85b8-bbce03aa91af"/> <!-- Tywnis -->
</authors>
<broadcasts>
    <tip after="5s">Check out /classes</tip>
    <tip after="6s">Change class with /class "name"</tip>
    <tip after="2m" count="5">Check out /classes</tip>
    <tip after="2m" count="5">Change class with /class "name"</tip>
</broadcasts>
<teams>
    <team id="blue-team" color="blue" max="12">Blue</team>
    <team id="red-team" color="dark red" max="12">Red</team>
</teams>
<kits>
    <kit id="spawn-kit">
        <game-mode>adventure</game-mode>
        <effect>night vision</effect>
    </kit>
</kits>
<classes family="ghost" sticky="false">
    <class name="Scion" default="true" description="All Rounder" longdescription="Jack of all Trades, and master of None!" icon="emerald">
        <kit>
            <item slot="0" material="stone sword" unbreakable="true"/>
            <item slot="1" material="bow" unbreakable="true"/>
            <item slot="2" material="golden apple"/>
            <item slot="8" material="arrow" amount="16"/>
            <effect ambient="true">damage resistance</effect>
            <helmet team-color="true" unbreakable="true" material="leather helmet"/>
            <chestplate team-color="true" unbreakable="true" material="leather chestplate"/>
            <leggings team-color="true" unbreakable="true" enchantment="protection projectile:1" material="leather leggings"/>
            <boots team-color="true" unbreakable="true" material="leather boots"/>
        </kit>
    </class>
    <class name="Champion" default="false" description="Sharp and true" longdescription="Live by the Sword, and die by it!" icon="iron sword">
        <kit>
            <item slot="0" material="iron sword" unbreakable="true"/>
            <item slot="1" material="golden apple"/>
            <effect amplifier="-1">health boost</effect>
            <effect ambient="true">damage resistance</effect>
            <helmet team-color="true" unbreakable="true" material="leather helmet"/>
            <chestplate team-color="true" unbreakable="true" material="leather chestplate"/>
            <leggings material="gold leggings" enchantment="protection projectile:2" unbreakable="true"/>
            <boots material="gold boots" unbreakable="true"/>
        </kit>
    </class>
    <class name="Juggernaut" default="false" description="Sturdy and reliable" longdescription="Stalwart guardian of the scorebox" icon="iron helmet">
        <kit>
            <item slot="0" material="stone sword" unbreakable="true"/>
            <item slot="1" amount="3" material="golden apple"/>
            <effect>health boost</effect>
            <effect amplifier="2" ambient="true">damage resistance</effect>
            <effect amplifier="2" ambient="true">slow</effect>
            <helmet unbreakable="true" material="iron helmet"/>
            <chestplate team-color="true" unbreakable="true" material="leather chestplate"/>
            <leggings unbreakable="true" enchantment="protection projectile:3" material="iron leggings"/>
            <boots unbreakable="true" material="iron boots"/>
        </kit>
    </class>
    <class name="Ranger" default="false" description="Agile and quick!" longdescription="A whistle, a feather, it's gone..." icon="bow">
        <kit>
            <item slot="0" enchantment="power" material="bow" unbreakable="true"/>
            <item slot="1" amount="2" material="golden apple"/>
            <item slot="8" material="arrow" amount="64"/>
            <effect amplifier="-3">health boost</effect>
            <effect ambient="true">damage resistance</effect>
            <effect ambient="true">speed</effect>
            <helmet team-color="true" unbreakable="true" material="leather helmet"/>
            <chestplate team-color="true" unbreakable="true" material="leather chestplate"/>
            <leggings material="chainmail leggings" enchantment="protection projectile:3" unbreakable="true"/>
            <boots material="chainmail boots" unbreakable="true"/>
        </kit>
    </class>
</classes>
<spawns>
    <default yaw="-90">
        <region>
            <point>2,32,2</point>
        </region>
    </default>
    <spawn team="blue-team" kit="spawn-kit">
        <region>
            <cuboid min="24,2,-6" max="26,2,-4"/>
        </region>
    </spawn>
    <spawn team="red-team" kit="spawn-kit" yaw="180">
        <region>
            <cuboid min="24,2,54" max="22,6,56"/>
        </region>
    </spawn>
</spawns>
<regions>
    <cuboid id="fill-cuboid" min="5,11,15" size="5,2,5"/>
    <apply block="not(participating)"/>
    <apply block-physics="physics-filter"/>
</regions>
<time result="score" overtime="45s" max-overtime="3m15s">10m</time>
<score>
    <kills>3</kills> <!-- +5 points for every kill -->
    <deaths>2</deaths> <!-- -2 points for accidentally dying -->
</score>
<blitz>
    <lives>3</lives>
    <broadcastLives>true</broadcastLives>
</blitz>
<respawn auto="true"/>
<block-drops>
    <rule punch="true">
        <filter>
            <material>gold block</material>
        </filter>
        <drops>
            <item chance="0.03" material="golden apple"/>
            <item chance="0.02" material="arrow"/>
            <item chance="0.01" amount="1" material="potion" damage="16396" name="Gaz Grenade">
                <effect duration="1m" amplifier="2">poison</effect>
            </item>
        </drops>
    </rule>
</block-drops>
<actions>
    <!--
      copyToBackup: Backs up wall array for potential rollback.
    -->
    <action id="copyToBackup" scope="match" expose="true">
        <set var="i" value="0"/>
        <repeat times="WALL_COUNT">
            <set var="wallsBack" index="i" value="walls[i]"/>
            <set var="i" value="i+1"/>
        </repeat>
    </action>
    <!--
      restoreFromBackup: Restores walls from backup after failed change.
    -->
    <action id="restoreFromBackup" scope="match" expose="true">
        <set var="i" value="0"/>
        <repeat times="WALL_COUNT">
            <set var="walls" index="i" value="wallsBack[i]"/>
            <set var="i" value="i+1"/>
        </repeat>
    </action>
    <!--
      resetShadow: Zeros out shadow array for fresh flood fill.
    -->
    <action id="resetShadow" scope="match" expose="true">
        <set var="i" value="0"/>
        <repeat times="CELL_COUNT">
            <set var="shadow" index="i" value="0"/>
            <set var="i" value="i+1"/>
        </repeat>
    </action>
    <!--
      countShadow: Sums shadow array to count reachable cells.
      @output shadowSum
    -->
    <action id="countShadow" scope="match" expose="true">
        <set var="shadowSum" value="0"/>
        <set var="i" value="0"/>
        <repeat times="CELL_COUNT">
            <set var="shadowSum" value="shadowSum + shadow[i]"/>
            <set var="i" value="i+1"/>
        </repeat>
    </action>
    <!--
      computeWallIndices: Computes wall array indices from cell coordinates.
      @input x, y
      @output leftWall, rightWall, upWall, downWall
    -->
    <action id="computeWallIndices" scope="match" expose="true">
        <set var="leftWall" value="y*V_STRIDE + x"/>
        <set var="rightWall" value="y*V_STRIDE + x + 1"/>
        <set var="upWall" value="H_WALL_OFFSET + y*GRID_SIZE + x"/>
        <set var="downWall" value="H_WALL_OFFSET + (y+1)*GRID_SIZE + x"/>
    </action>
    <!--
      incrementShadow: One iteration of flood fill propagation.
    -->
    <action id="incrementShadow" scope="match" expose="true">
        <set var="i" value="0"/>
        <repeat times="CELL_COUNT">
            <set var="x" value="i % GRID_SIZE"/>
            <set var="y" value="floor(i/GRID_SIZE)"/>
            <action id="computeWallIndices"/>
            <action filter="all(shadow[i]=0, any(all(x-ge-1, walls[leftWall]=0, shadow[i-1]=1), all(x-le-3, walls[rightWall]=0, shadow[i+1]=1), all(y-ge-1, walls[upWall]=0, shadow[i-GRID_SIZE]=1), all(y-le-3, walls[downWall]=0, shadow[i+GRID_SIZE]=1)))">
                <set var="shadow" index="i" value="1"/>
            </action>
            <set var="i" value="i+1"/>
        </repeat>
    </action>
    <!--
      floodFill: Runs complete flood fill from cell 0.
    -->
    <action id="floodFill" scope="match" expose="true">
        <action id="resetShadow"/>
        <set var="shadow" index="0" value="1"/>
        <repeat times="CELL_COUNT - 1">
            <action id="incrementShadow"/>
        </repeat>
    </action>
    <!--
      computeWallIndex: Converts randWall (0-39) to wall array index.
      @input randWall
      @output wallIndex
    -->
    <action id="computeWallIndex" scope="match" expose="true">
        <action filter="randWall-le-19">
            <set var="wallIndex" value="floor(randWall / (GRID_SIZE - 1)) * V_STRIDE + (randWall % (GRID_SIZE - 1)) + 1"/>
        </action>
        <action filter="randWall-ge-20">
            <set var="adjustedRand" value="randWall - INTERIOR_WALL_COUNT / 2"/>
            <set var="wallIndex" value="H_WALL_OFFSET + (floor(adjustedRand / GRID_SIZE) + 1) * GRID_SIZE + (adjustedRand % GRID_SIZE)"/>
        </action>
    </action>
    <!--
      flipRandomWall: Randomly toggles a wall, validates connectivity.
    -->
    <action id="flipRandomWall" scope="match" expose="true">
        <set var="randWall" value="floor(random() * INTERIOR_WALL_COUNT)"/>
        <action id="computeWallIndex"/>
        <set var="rerollCheck" value="floor(random() * 100)"/>
        <action filter="all(walls[wallIndex]=1, shouldReroll)">
            <set var="randWall" value="floor(random() * INTERIOR_WALL_COUNT)"/>
            <action id="computeWallIndex"/>
        </action>
        <action id="copyToBackup"/>
        <set var="walls" index="wallIndex" value="1 - walls[wallIndex]"/>
        <action id="floodFill"/>
        <action id="countShadow"/>
        <!-- Restore if not all cells reachable -->
        <action filter="shouldRestore">
            <action id="restoreFromBackup"/>
        </action>
    </action>
    <!--
      initializeEdgeWalls: Sets boundary walls (except spawn entrances).
    -->
    <action id="initializeEdgeWalls" scope="match" expose="true">
        <!-- Left edge (column 0 of vertical walls) -->
        <set var="walls" index="0" value="1"/>
        <set var="walls" index="6" value="1"/>
        <set var="walls" index="12" value="1"/>
        <set var="walls" index="18" value="1"/>
        <set var="walls" index="24" value="1"/>
        <!-- Right edge (column 5 of vertical walls) -->
        <set var="walls" index="5" value="1"/>
        <set var="walls" index="11" value="1"/>
        <set var="walls" index="17" value="1"/>
        <set var="walls" index="23" value="1"/>
        <set var="walls" index="29" value="1"/>
        <!-- Top edge (row 0 of horizontal walls, skip index 32 for blue spawn) -->
        <set var="walls" index="30" value="1"/>
        <set var="walls" index="31" value="1"/>
        <set var="walls" index="33" value="1"/>
        <set var="walls" index="34" value="1"/>
        <!-- Bottom edge (row 5 of horizontal walls, skip index 57 for red spawn) -->
        <set var="walls" index="55" value="1"/>
        <set var="walls" index="56" value="1"/>
        <set var="walls" index="58" value="1"/>
        <set var="walls" index="59" value="1"/>
    </action>
    <!--
      generateMaze: Main entry point for maze generation.
    -->
    <action id="generateMaze" scope="match">
        <action id="initializeEdgeWalls"/>
        <repeat times="MAZE_ITERATIONS">
            <action id="flipRandomWall"/>
        </repeat>
    </action>
    <!--
      computeCellData: Computes cell/world coordinates and wall configuration.
      @input i
      @output x, y, worldX, worldZ, wallConfig
    -->
    <action id="computeCellData" scope="match" expose="true">
        <set var="x" value="i % GRID_SIZE"/>
        <set var="y" value="floor(i / GRID_SIZE)"/>
        <set var="worldX" value="x * CELL_SIZE + WORLD_OFFSET"/>
        <set var="worldZ" value="y * CELL_SIZE + WORLD_OFFSET"/>
        <action id="computeWallIndices"/>
        <set var="wallConfig" value="walls[rightWall] + walls[downWall] * 2 + walls[leftWall] * 4 + walls[upWall] * 8"/>
    </action>
    <!--
      pasteCell: Pastes structure based on wall configuration.
      @input wallConfig, worldX, worldZ
    -->
    <action id="pasteCell" scope="match" expose="true">
        <action filter="wallConfig=0">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-8" update="false"/>
        </action>
        <action filter="wallConfig=1">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-6" update="false"/>
        </action>
        <action filter="wallConfig=2">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-7" update="false"/>
        </action>
        <action filter="wallConfig=3">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-15" update="false"/>
        </action>
        <action filter="wallConfig=4">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-4" update="false"/>
        </action>
        <action filter="wallConfig=5">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-1" update="false"/>
        </action>
        <action filter="wallConfig=6">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-3" update="false"/>
        </action>
        <action filter="wallConfig=7">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-9" update="false"/>
        </action>
        <action filter="wallConfig=8">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-5" update="false"/>
        </action>
        <action filter="wallConfig=9">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-12" update="false"/>
        </action>
        <action filter="wallConfig=10">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-2" update="false"/>
        </action>
        <action filter="wallConfig=11">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-14" update="false"/>
        </action>
        <action filter="wallConfig=12">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-0" update="false"/>
        </action>
        <action filter="wallConfig=13">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-13" update="false"/>
        </action>
        <action filter="wallConfig=14">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-10" update="false"/>
        </action>
        <action filter="wallConfig=15">
            <paste-structure x="worldX" y="1" z="worldZ" structure="structure-11" update="false"/>
        </action>
    </action>
    <!--
      pasteMaze: Iterates cells and pastes maze structures.
    -->
    <action id="pasteMaze" scope="match">
        <set var="i" value="0"/>
        <repeat times="CELL_COUNT">
            <action id="computeCellData"/>
            <action id="pasteCell"/>
            <set var="i" value="i + 1"/>
        </repeat>
    </action>
    <trigger filter="always" action="generateMaze" scope="match"/>
    <trigger filter="structure-filter" action="pasteMaze" scope="match"/>
</actions>
<filters>
    <!-- Allows when the t_score variable is greater than or equal to 100 -->
    <after id="physics-filter" duration="5s">
        <match-started id="structure-filter"/>
    </after>
    <variable id="x-ge-1" var="x">1..</variable>
    <variable id="x-le-3" var="x">..3</variable>
    <variable id="y-ge-1" var="y">1..</variable>
    <variable id="y-le-3" var="y">..3</variable>
    <variable id="randWall-le-19" var="randWall">..19</variable>
    <variable id="randWall-ge-20" var="randWall">20..</variable>
    <variable id="shouldRestore" var="shadowSum">..24</variable>
    <variable id="shouldReroll" var="rerollCheck">..60</variable>
</filters>
<variables>
    <variable id="GRID_SIZE" scope="match" default="5"/>
    <variable id="CELL_COUNT" scope="match" default="25"/>
    <variable id="WALL_COUNT" scope="match" default="60"/>
    <variable id="H_WALL_OFFSET" scope="match" default="30"/>
    <variable id="V_STRIDE" scope="match" default="6"/>
    <variable id="INTERIOR_WALL_COUNT" scope="match" default="40"/>
    <variable id="CELL_SIZE" scope="match" default="10"/>
    <variable id="WORLD_OFFSET" scope="match" default="1"/>
    <variable id="MAZE_ITERATIONS" scope="match" default="200"/>
    <variable id="i" scope="match" default="0"/>
    <variable id="vIndex" scope="match" default="0"/>
    <variable id="hIndex" scope="match" default="0"/>
    <variable id="x" scope="match" default="0"/>
    <variable id="y" scope="match" default="0"/>
    <variable id="leftWall" scope="match" default="0"/>
    <variable id="rightWall" scope="match" default="0"/>
    <variable id="upWall" scope="match" default="0"/>
    <variable id="downWall" scope="match" default="0"/>
    <variable id="shadowSum" scope="match" default="0"/>
    <variable id="randWall" scope="match" default="0"/>
    <variable id="adjustedRand" scope="match" default="0"/>
    <variable id="wallIndex" scope="match" default="0"/>
    <variable id="worldX" scope="match" default="0"/>
    <variable id="worldZ" scope="match" default="0"/>
    <variable id="wallConfig" scope="match" default="0"/>
    <variable id="rerollCheck" scope="match" default="0"/>
    <array id="walls" scope="match" size="60"/>
    <array id="wallsBack" scope="match" size="60"/>
    <array id="shadow" scope="match" size="25"/>
</variables>
<structures>
    <!-- LEFT+UP walls (wallConfig=12) -->
    <structure air="true" clear="false" id="structure-0"><region><cuboid min="1,0,200" size="10,20,10"/></region></structure>
    <!-- RIGHT+LEFT walls (wallConfig=5) -->
    <structure air="true" clear="false" id="structure-1"><region><cuboid min="1,0,212" size="10,20,10"/></region></structure>
    <!-- DOWN+UP walls (wallConfig=10) -->
    <structure air="true" clear="false" id="structure-2"><region><cuboid min="1,0,224" size="10,20,10"/></region></structure>
    <!-- LEFT+DOWN walls (wallConfig=6) -->
    <structure air="true" clear="false" id="structure-3"><region><cuboid min="1,0,236" size="10,20,10"/></region></structure>
    <!-- LEFT wall (wallConfig=4) -->
    <structure air="true" clear="false" id="structure-4"><region><cuboid min="13,0,200" size="10,20,10"/></region></structure>
    <!-- UP wall (wallConfig=8) -->
    <structure air="true" clear="false" id="structure-5"><region><cuboid min="13,0,212" size="10,20,10"/></region></structure>
    <!-- RIGHT wall (wallConfig=1) -->
    <structure air="true" clear="false" id="structure-6"><region><cuboid min="13,0,224" size="10,20,10"/></region></structure>
    <!-- DOWN wall (wallConfig=2) -->
    <structure air="true" clear="false" id="structure-7"><region><cuboid min="13,0,236" size="10,20,10"/></region></structure>
    <!-- No walls (wallConfig=0) -->
    <structure air="true" clear="false" id="structure-8"><region><cuboid min="25,0,200" size="10,20,10"/></region></structure>
    <!-- RIGHT+DOWN+LEFT walls (wallConfig=7) -->
    <structure air="true" clear="false" id="structure-9"><region><cuboid min="25,0,212" size="10,20,10"/></region></structure>
    <!-- LEFT+DOWN+UP walls (wallConfig=14) -->
    <structure air="true" clear="false" id="structure-10"><region><cuboid min="25,0,224" size="10,20,10"/></region></structure>
    <!-- All walls (wallConfig=15) -->
    <structure air="true" clear="false" id="structure-11"><region><cuboid min="25,0,236" size="10,20,10"/></region></structure>
    <!-- RIGHT+UP walls (wallConfig=9) -->
    <structure air="true" clear="false" id="structure-12"><region><cuboid min="37,0,200" size="10,20,10"/></region></structure>
    <!-- RIGHT+LEFT+UP walls (wallConfig=13) -->
    <structure air="true" clear="false" id="structure-13"><region><cuboid min="37,0,212" size="10,20,10"/></region></structure>
    <!-- RIGHT+DOWN+UP walls (wallConfig=11) -->
    <structure air="true" clear="false" id="structure-14"><region><cuboid min="37,0,224" size="10,20,10"/></region></structure>
    <!-- RIGHT+DOWN walls (wallConfig=3) -->
    <structure air="true" clear="false" id="structure-15"><region><cuboid min="37,0,236" size="10,20,10"/></region></structure>
</structures>
<toolrepair>
    <tool>stone sword</tool>
    <tool>bow</tool>
</toolrepair>
<itemremove>
    <item>leather helmet</item>
    <item>leather chestplate</item>
    <item>leather leggings</item>
    <item>leather boots</item>
    <item>chainmail helmet</item>
    <item>chainmail chestplate</item>
    <item>chainmail leggings</item>
    <item>chainmail boots</item>
    <item>iron helmet</item>
    <item>iron chestplate</item>
    <item>iron leggings</item>
    <item>iron boots</item>
    <item>gold helmet</item>
    <item>gold chestplate</item>
    <item>gold leggings</item>
    <item>gold boots</item>
    <item>diamond helmet</item>
    <item>diamond chestplate</item>
    <item>diamond leggings</item>
    <item>diamond boots</item>
    <item>bow</item>
    <item>stone sword</item>
    <item>iron sword</item>
</itemremove>
<kill-rewards>
    <kill-reward>
        <item material="arrow" amount="3"/>
    </kill-reward>
</kill-rewards>
<disabledamage>
    <damage>fall</damage>
</disabledamage>
<hunger>
    <depletion>off</depletion>
</hunger>
<timelock>on</timelock>
</map>
